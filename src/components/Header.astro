---
import { Github, Search, Menu, X, Moon, Sun, FileText, Folder } from "@lucide/astro";
import { getCollection } from "astro:content";
import { SITE_TITLE } from "../consts";
import HeaderLink from "./HeaderLink.astro";

const quickLinks = [
	{ name: "Home", href: "/" },
	{ name: "Collections", href: "/collections" },
	{ name: "Posts", href: "/blog" },
	{ name: "About", href: "/about" },
];

// Get all posts and collections for search
const posts = (await getCollection("blog")).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const collections = (await getCollection("category")).sort((a, b) =>
	a.data.title.localeCompare(b.data.title),
);

// Prepare search data
const searchData = {
	posts: posts.map((post) => ({
		id: post.id,
		title: post.data.title,
		description: post.data.description,
		collection: post.data.collection,
		pubDate: post.data.pubDate.toISOString(),
		href: `/blog/${post.id}/`,
	})),
	collections: collections.map((col) => ({
		id: col.id.replace(".md", ""),
		title: col.data.title,
		description: col.data.description,
		href: `/collections/${col.id.replace(".md", "")}/`,
	})),
};
---

<header class="w-full py-4 md:py-6 sticky top-0 bg-background backdrop-blur-md z-50">
	<nav class="flex items-center justify-between flex-row gap-4 px-3">
		<!-- Logo -->
		<h2 class="text-2xl"><a href="/">{SITE_TITLE}</a></h2>

		<!-- Desktop Navigation -->
		<div class="hidden md:flex flex-1 h-11 flex-row justify-between items-center border-black/30 border rounded-full py-0 pl-15 overflow-hidden">
			<div class="flex flex-row gap-4 items-center">
				{
					quickLinks.map((link, index) => (
						<>
							<HeaderLink href={link.href}>
								{link.name}
							</HeaderLink>
							{index < quickLinks.length - 1 && (
								<div class="w-1 h-1 rounded-full bg-black" />
							)}
						</>
					))
				}
			</div>
			<a href="https://github.com/kzares-dev" target="_blank" rel="noopener noreferrer"
				class="m-1 aspect-square h-9 flex items-center justify-center bg-primary rounded-full hover:opacity-80 transition-opacity"
			>
				<Github size={18} />
			</a>
		</div>

		<!-- Desktop Search -->
		<div class="hidden md:flex w-60 flex-row gap-2 items-center bg-card border-border border px-3 rounded-full h-11 cursor-pointer hover:border-primary/50 transition-colors" id="desktop-search-trigger">
			<Search size={20} />
			<span class="text-sm text-muted-foreground">Search topic....</span>
		</div>

		<!-- Mobile Buttons -->
		<div class="md:hidden flex items-center gap-2">
			<button 
				id="mobile-search-toggle"
				class="flex items-center justify-center w-10 h-10 bg-primary rounded-full hover:opacity-80 transition-opacity"
				type="button"
			>
				<Search size={18} />
			</button>
			<button 
				id="menu-toggle"
				class="flex items-center justify-center w-10 h-10 border-black/30 border rounded-full hover:opacity-80 transition-opacity"
				type="button"
			>
				<Menu id="menu-icon" size={20} />
				<X id="close-icon" size={20} class="hidden" />
			</button>
		</div>
	</nav>

	<!-- Mobile Search Bar (Hidden by default) -->
	<div id="mobile-search-bar" class="hidden md:hidden px-3 py-2 border-t border-[rgb(245,175,175)]/20">
		<div class="flex flex-row gap-2 items-center bg-card border-[rgb(220,100,100)]/30 border px-3 rounded-full h-10 cursor-pointer" id="mobile-search-trigger">
			<Search size={18} class="text-[rgb(220,100,100)] flex-shrink-0" />
			<span class="text-sm text-stone-500">Search topic...</span>
		</div>
	</div>

	<!-- Mobile Navigation Menu (Hidden by default) -->
	<div id="mobile-menu" class="hidden md:hidden border-t border-[rgb(245,175,175)]/20">
		<div class="flex flex-col gap-2 px-4 py-4">
			{
				quickLinks.map((link) => (
					<a
						href={link.href}
						class="px-4 py-3 rounded-lg text-stone-800 hover:bg-[rgb(245,175,175)]/50 transition-colors font-medium"
					>
						{link.name}
					</a>
				))
			}
			<a
				href="https://github.com"
				target="_blank"
				rel="noopener noreferrer"
				class="px-4 py-3 rounded-lg bg-[rgb(220,100,100)] text-white hover:bg-[rgb(200,70,70)] transition-colors font-medium flex items-center gap-2"
			>
				<Github size={18} />
				GitHub
			</a>
		</div>
	</div>
</header>

{/* Search Modal */}
<div id="search-modal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm overflow-y-auto">
	<div class="flex items-start justify-center pt-12 md:pt-20 px-4 min-h-screen">
		<div class="w-full max-w-2xl bg-background rounded-xl shadow-2xl border border-border/20 overflow-hidden">
			{/* Search Input */}
			<div class="sticky top-0 bg-background p-6 border-b border-border/20">
				<div class="flex items-center gap-3 bg-card border border-border/30 rounded-lg px-4 py-3">
					<Search size={20} class="text-primary flex-shrink-0" />
					<input
						id="search-input"
						type="text"
						placeholder="Search collections and articles..."
						class="flex-1 border-none outline-none bg-transparent text-foreground focus:ring-0"
						autocomplete="off"
					/>
					<button id="search-close-btn" class="text-muted-foreground hover:text-foreground transition-colors">
						<X size={20} />
					</button>
				</div>
			</div>

			{/* Search Results */}
			<div id="search-results" class="max-h-[600px] overflow-y-auto">
				{/* Collections Section */}
				<div id="collections-section" class="hidden border-b border-border/20">
					<div class="px-6 pt-4 pb-3">
						<div class="flex items-center gap-2 mb-4">
							<Folder size={18} class="text-primary" />
							<h3 class="text-sm font-bold uppercase tracking-wider text-muted-foreground">Collections</h3>
							<span id="collections-count" class="text-xs font-semibold bg-primary/10 text-primary px-2 py-1 rounded"></span>
						</div>
						<div id="collections-list" class="space-y-2"></div>
					</div>
				</div>

				{/* Articles Section */}
				<div id="articles-section" class="hidden">
					<div class="px-6 pt-4 pb-3">
						<div class="flex items-center gap-2 mb-4">
							<FileText size={18} class="text-primary" />
							<h3 class="text-sm font-bold uppercase tracking-wider text-muted-foreground">Articles</h3>
							<span id="articles-count" class="text-xs font-semibold bg-primary/10 text-primary px-2 py-1 rounded"></span>
						</div>
						<div id="articles-list" class="space-y-2"></div>
					</div>
				</div>

				{/* No Results */}
				<div id="no-results" class="hidden px-6 py-12 text-center">
					<Search size={48} class="mx-auto text-muted-foreground/30 mb-4" />
					<p class="text-muted-foreground">No results found. Try a different search term.</p>
				</div>

				{/* Initial State */}
				<div id="initial-state" class="px-6 py-12 text-center">
					<Search size={48} class="mx-auto text-muted-foreground/30 mb-4" />
					<p class="text-muted-foreground">Start typing to search for collections and articles...</p>
				</div>
			</div>
		</div>
	</div>
</div>

<script is:inline define:vars={{ searchData }}>
	const searchModal = document.getElementById("search-modal");
	const searchInput = document.getElementById("search-input");
	const searchCloseBtn = document.getElementById("search-close-btn");
	const desktopSearchTrigger = document.getElementById("desktop-search-trigger");
	const mobileSearchTrigger = document.getElementById("mobile-search-trigger");

	// Open modal
	function openSearchModal() {
		searchModal.classList.remove("hidden");
		searchInput.focus();
	}

	// Close modal
	function closeSearchModal() {
		searchModal.classList.add("hidden");
		searchInput.value = "";
		performSearch("");
	}

	// Event listeners for opening modal
	desktopSearchTrigger?.addEventListener("click", openSearchModal);
	mobileSearchTrigger?.addEventListener("click", openSearchModal);
	searchCloseBtn?.addEventListener("click", closeSearchModal);

	// Close on Escape key
	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape") {
			closeSearchModal();
		}
		if (e.key === "/" && !searchModal.classList.contains("hidden") === false) {
			e.preventDefault();
			openSearchModal();
		}
	});

	// Close on backdrop click
	searchModal?.addEventListener("click", (e) => {
		if (e.target === searchModal) {
			closeSearchModal();
		}
	});

	// Search functionality
	function performSearch(query) {
		const searchTerm = query.toLowerCase().trim();

		const collectionsSection = document.getElementById("collections-section");
		const articlesSection = document.getElementById("articles-section");
		const noResults = document.getElementById("no-results");
		const initialState = document.getElementById("initial-state");
		const collectionsList = document.getElementById("collections-list");
		const articlesList = document.getElementById("articles-list");
		const collectionsCount = document.getElementById("collections-count");
		const articlesCount = document.getElementById("articles-count");

		// Reset visibility
		collectionsSection.classList.add("hidden");
		articlesSection.classList.add("hidden");
		noResults.classList.add("hidden");
		initialState.classList.add("hidden");

		if (!searchTerm) {
			initialState.classList.remove("hidden");
			return;
		}

		// Filter collections
		const filteredCollections = searchData.collections.filter(
			(col) =>
				col.title.toLowerCase().includes(searchTerm) ||
				col.description.toLowerCase().includes(searchTerm)
		);

		// Filter articles
		const filteredArticles = searchData.posts.filter(
			(post) =>
				post.title.toLowerCase().includes(searchTerm) ||
				post.description.toLowerCase().includes(searchTerm)
		);

		// Show results
		if (filteredCollections.length === 0 && filteredArticles.length === 0) {
			noResults.classList.remove("hidden");
			return;
		}

		// Render collections
		if (filteredCollections.length > 0) {
			collectionsSection.classList.remove("hidden");
			collectionsCount.textContent = filteredCollections.length;
			collectionsList.innerHTML = filteredCollections
				.map(
					(col) => `
						<a href="${col.href}" class="block px-4 py-3 rounded-lg hover:bg-primary/10 transition-colors group">
							<div class="font-semibold text-foreground group-hover:text-primary transition-colors">${col.title}</div>
							<div class="text-xs text-muted-foreground line-clamp-1 mt-1">${col.description}</div>
						</a>
					`
				)
				.join("");
		}

		// Render articles
		if (filteredArticles.length > 0) {
			articlesSection.classList.remove("hidden");
			articlesCount.textContent = filteredArticles.length;
			articlesList.innerHTML = filteredArticles
				.map(
					(post) => `
						<a href="${post.href}" class="block px-4 py-3 rounded-lg hover:bg-primary/10 transition-colors group">
							<div class="font-semibold text-foreground group-hover:text-primary transition-colors">${post.title}</div>
							<div class="text-xs text-muted-foreground line-clamp-1 mt-1">${post.description}</div>
						</a>
					`
				)
				.join("");
		}
	}

	// Search input event listener
	searchInput?.addEventListener("input", (e) => {
		performSearch(e.target.value);
	});
</script>

<script is:inline>
	function handleGlobalSearch(event) {
		event.preventDefault();
		const form = event.target;
		const query = form.querySelector('input[name="query"]').value.trim();
		if (query) {
			window.location.href = `/search?query=${encodeURIComponent(query)}`;
		}
	}

	// Mobile Menu Toggle
	const menuToggle = document.getElementById("menu-toggle");
	const mobileMenu = document.getElementById("mobile-menu");
	const menuIcon = document.getElementById("menu-icon");
	const closeIcon = document.getElementById("close-icon");
	const mobileSearchToggle = document.getElementById("mobile-search-toggle");
	const mobileSearchBar = document.getElementById("mobile-search-bar");

	if (menuToggle && mobileMenu) {
		menuToggle.addEventListener("click", () => {
			mobileMenu.classList.toggle("hidden");
			menuIcon.classList.toggle("hidden");
			closeIcon.classList.toggle("hidden");
		});

		// Close menu when clicking on a link
		const menuLinks = mobileMenu.querySelectorAll("a");
		menuLinks.forEach((link) => {
			link.addEventListener("click", () => {
				mobileMenu.classList.add("hidden");
				menuIcon.classList.remove("hidden");
				closeIcon.classList.add("hidden");
			});
		});
	}

	// Mobile Search Toggle
	if (mobileSearchToggle && mobileSearchBar) {
		mobileSearchToggle.addEventListener("click", () => {
			mobileSearchBar.classList.toggle("hidden");
			if (!mobileSearchBar.classList.contains("hidden")) {
				const searchInput = mobileSearchBar.querySelector('input[name="query"]');
				searchInput?.focus();
			}
		});
	}

	function initTheme() {
		const htmlElement = document.documentElement;
		const themeToggle = document.getElementById("theme-toggle");
		const sunIcon = document.getElementById("sun-icon");
		const moonIcon = document.getElementById("moon-icon");

		// Get saved theme or default to light
		const savedTheme = localStorage.getItem("theme");
		const isDark = savedTheme === "dark";

		// Apply initial theme
		if (isDark) {
			htmlElement.classList.add("dark");
			sunIcon?.classList.add("hidden");
			moonIcon?.classList.remove("hidden");
		} else {
			htmlElement.classList.remove("dark");
			sunIcon?.classList.remove("hidden");
			moonIcon?.classList.add("hidden");
		}

		// Theme toggle handler
		themeToggle?.addEventListener("click", () => {
			const isDarkMode = htmlElement.classList.contains("dark");

			if (isDarkMode) {
				htmlElement.classList.remove("dark");
				localStorage.setItem("theme", "light");
				sunIcon?.classList.remove("hidden");
				moonIcon?.classList.add("hidden");
			} else {
				htmlElement.classList.add("dark");
				localStorage.setItem("theme", "dark");
				sunIcon?.classList.add("hidden");
				moonIcon?.classList.remove("hidden");
			}
		});
	}

	// Initialize theme on page load and on navigation
	initTheme();
	document.addEventListener("astro:after-swap", initTheme);
</script>
